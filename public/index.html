<html ng-app="gestureTalk">

<head>
    <title>Gesture Talk</title>
    <style>
    body {
        font-family: "Helvetica Neue";
    }
    
    .fullscreen {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
    
    .column {
        display: flex;
        flex-direction: row;
    }
    
    .row {
        display: flex;
        flex-direction: column;
    }
    
    .flex {
        flex: 1;
    }
    
    .main-panel {
        text-align: center;
        align-items: center;
        justify-content: center;
    }
    
    .side-panel {
        width: 30%;
        background-color: lightgray;
        padding: 8px;
        text-align: center;
    }
    
    .empty-chatbox {}
    
    .empty-chatbox-message {
        width: 200px;
    }
    
    .chatbox {
        height: 100%;
        width: 100%;
        padding: 8px;
        list-style: none;
    }
    
    .chat-bubble {
        width: -webkit-fit-content;
        height: -webkit-fit-content;
        max-width: 70%;
        margin-top: 1em;
        padding: 0.4em 0.8em 0.4em 0.8em;
        text-align: center;
        overflow: wrap;
        -webkit-border-radius: 30px;
        -moz-border-radius: 30px;
        border-radius: 30px;
        position: inline-block;
    }
    
    .chat-bubble.sender {
        color: white;
        background-color: #0B93F6;
    }
    
    .chat-bubble.receiver {
        background-color: #E5E5EA;
    }
    
    .hand-image {
        height: 200px;
        width: 200px;
        -webkit-animation: fade 2s infinite;
        -moz-animation: fade 2s infinite;
        -o-animation: fade 2s infinite;
        animation: fade 2s infinite;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        background-image: url('/resources/blueHand.png');
    }
    
    .hidden {
        display: none;
    }
    
    .silhouette {
        height: 200px;
        width: 200px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        background-image: url('silhouette.png');
    }
    
    @-webkit-keyframes fade {
        0% {
            opacity: 0.3;
        }
        50% {
            opacity: 1;
        }
        100% {
            opacity: 0.3;
        }
    }
    
    @-moz-keyframes fade {
        0% {
            opacity: 0.3;
        }
        50% {
            opacity: 1;
        }
        100% {
            opacity: 0.3;
        }
    }
    
    @-o-keyframes fade {
        0% {
            opacity: 0.3;
        }
        50% {
            opacity: 1;
        }
        100% {
            opacity: 0.3;
        }
    }
    
    @keyframes fade {
        0% {
            opacity: 0.3;
        }
        50% {
            opacity: 1;
        }
        100% {
            opacity: 0.3;
        }
    }
    </style>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script type="text/javascript" src="lib/MyoJS-master/myo.js"></script>
</head>

<body class="fullscreen column">
    <div class="flex main-panel row">
        <div id="empty-chatbox" class="empty-chatbox">
            <div class="hand-image"></div>
            <div class="empty-chatbox-message">To begin chatting, make the 'Fingers spread' gesture or click 'Start Room'</div>
            <button onclick="joinRoom()">Start Room</button>
        </div>
        <div id="chatbox" class="chatbox row">
            <div id="chat-content" class="chat-content flex"></div>
            <input type="text" />
            <button>Send</button>
        </div>
    </div>
    <div class="side-panel">
        <h1>Gesture Chat</h1>The Gesture/Voice messaging app
        <div class="silhouette"></div>
        <div>Your Name Here</div>
    </div>
    <script>
    Myo.connect();

    function clearMessages() {
        var messageContainer = document.getElementById('chat-content');
        for (var i = 0; i < messageContainer.children.length; i++) {
            var child = messageContainer.children[i];
            messageContainer.removeChild(child);
        }
    }

    function addMessage(message, isFromSender) {
        var messageContainer = document.getElementById('chat-content');
        var newMessageDiv = document.createElement('div');
        newMessageDiv.innerText = message;
        newMessageDiv.className = "chat-bubble " + (isFromSender ? "sender" : "receiver");
        messageContainer.appendChild(newMessageDiv);

        speak(message);
    }

    function startListeningForMessages(shouldStartListening) {
        if (shouldStartListening) {
            Myo.on('pose', function(poseName) {
                switch (poseName) {
                    case 'fingers_spread':
                        addMessage("hi, how are you? I'm deaf", true);
                        break;
                    case 'wave_in':
                        addMessage("Welcome, come on in :)", true);
                        break;
                    case 'wave_out':
                        addMessage("Get out of my car now!", true);
                        break;
                    case 'fist':
                        addMessage("Having a good night?", true);
                        break;
                    default:
                        addMessage("hello, can you hear me?");
                }

            });
        } else {
            Myo.off('pose');
        }

    };

    function changeConnectedState(connected) {
        var emptyChatbox = document.getElementById('empty-chatbox');
        var chatbox = document.getElementById('chatbox');
        if (connected) {
            emptyChatbox.hidden = true;
            chatbox.className = chatbox.className.replace(/\bhidden\b/, "")
            Myo.off('fingers_spread');

            startListeningForMessages(true);
        } else {
            clearMessages();
            emptyChatbox.hidden = false;
            chatbox.className = chatbox.className + " hidden"
            Myo.on('fingers_spread', function() {
                speak("Activation pose detected, connecting to chat room.", function() {
                    setTimeout(function() {
                        joinRoom();
                    }, 300);
                });
            });

            startListeningForMessages(false);
        }
    }

    changeConnectedState(false);

    var socket = io();
    JOINING_ROOM = false;

    socket.on('joined_room', function(roomData) {
        changeConnectedState(true);
        JOINING_ROOM = false;
        console.log(roomData.roomId);
        speak("Alexa, ask Gesture Talk to join the room with I.D. " + roomData.speechifiedId);
    });

    socket.on('chatroom_begin', function() {
        speak('Successfully joined chatroom with Alexa.');
    });

    socket.on('new_message', function(message) {
        addMessage(message, false);
    });

    function joinRoom() {
        if (!JOINING_ROOM) {
            JOINING_ROOM = true;
            socket.emit('start_room');
        } else {
            console.warn("Join room requested. You are already attempting to join a room.");
        }
    }

    function speak(text, callback) {
        var u = new SpeechSynthesisUtterance();
        u.text = text;
        u.lang = 'en-US';

        u.onend = function() {
            if (callback) {
                callback();
            }
        };

        u.onerror = function(e) {
            if (callback) {
                callback(e);
            }
        };

        speechSynthesis.speak(u);
    }
    </script>
</body>

</html>